
<img align="right" src="./images/logo.png">



Lab 3. Schedule Cron with Puppet 
----------------------------------



In this lab, we will create a cron job to run bash script regularly .
Of course, we could do this work manually, but isn\'t this course partly
about the advantages of automation?


#### Setup Cron

Our Puppet manifest in `run-puppet-cron.pp` first install cron package and start cron service, copies bash script using a `file` resource, and then sets up a
cron job to run it every 2 minutes, using a `cron` resource.


```
# Set up regular Puppet runs

package { 'cron':
  ensure => installed,
}

service { 'cron':
  ensure  => running,
  enable  => true,
}

file { '/usr/local/bin/run-puppet-cron':
  source => '/examples/run-puppet-cron.sh',
  mode   => '0755',
}

cron { 'run-puppet-cron':
  command => '/usr/local/bin/run-puppet-cron',
  hour    => '*',
  minute  => '*/2',
}

```



#### Applying the run-puppet-cron manifest


`puppet apply /examples/run-puppet-cron.pp`


You can see from Puppet\'s output that it has created the
`/usr/local/bin/run-puppet-cron` script and the
`run-puppet-cron` cron job. This will now run automatically every 2 minutes, pull any new changes from the Git repo, and apply the
updated manifest.



### The run-puppet-cron script


run-puppet-cron script appends a line to `/tmp/cron.txt` file everytime it runs.


```
#!/bin/bash
echo '[Puppet Cron] Date:' $(date) >> /tmp/cron.txt
```



For now, just note that the `cron` resource has a name
(`run-puppet-cron`), which is just for the benefit of us humans, to
remind us what it does, and it also has a `command` to run and
`hour` and `minute` attributes to control when it
runs. The value `*/2` tells `cron` to run the job
every 2 minutes.



#### Task: Testing automatic Puppet runs

Verify that following file is updated after sometime by cron we setup using puppet.

`cat /tmp/cron.txt`


#### Task: Testing automatic Puppet runs


To prove that the automatic Puppet run works, make a
change to your manifest which creates a file
(`/tmp/hello.txt`, for example)  and run puppet apply command. Wait 2 minutes, and check your target node. The file should be
present. If not, something is broken. To troubleshoot the problem, try
running `sudo run-puppet-cron` manually. If this works, check that
the cron job is correctly installed by running
`sudo crontab -l`. It should look something like the following:


``` 
# HEADER: This file was autogenerated at 2017-04-05 01:46:03 -0700 by puppet.
# HEADER: While it can still be managed manually, it is definitely not recommended.
# HEADER: Note particularly that the comments starting with 'Puppet Name' should
# HEADER: not be deleted, as doing so could cause duplicate cron jobs.
# Puppet Name: run-puppet-cron
*/2 * * * * /usr/local/bin/run-puppet-cron
```



Summary
-------------------------


In this lab, we introduced the concepts of version control, and the
essentials of Git in particular. We set up a new Git repo, created a
GitHub account, pushed our code to it, and cloned it on a node. We wrote
a shell script to automatically pull and apply changes from the GitHub
repo on any node, and a Puppet manifest to install this script and run
it regularly from `cron`.
